# Token认证系统修复测试指南

## 修复内容总结

### 1. 创建了AuthSessionHelper辅助类
- 实现了基于IP地址的会话查找功能
- 添加了共享密钥验证方法
- 提供了调试信息打印功能

### 2. 修改了会话查找逻辑
- 在AuthPacketHandler中使用新的会话查找方式
- 在AuthSessionManager中增加了详细的调试日志

### 3. 增加了调试日志
- 客户端：添加了令牌生成器状态检查
- 服务器端：添加了会话查找和验证的详细日志
- 会话管理：增加了会话创建和清理的详细日志

### 4. 修改了时间容差设置
- 服务器时间窗口：从30秒增加到60秒
- 服务器响应超时：从5秒增加到15秒
- 客户端超时：从10秒增加到15秒
- 时间验证精度：从1秒提高到0.5秒

### 5. 修复了服务器线程阻塞问题 ⚠️
- **关键修复**：解决了AuthEventHandler中在服务器主线程调用Thread.sleep()导致的阻塞问题
- 使用ScheduledExecutorService替代阻塞式超时检查
- 避免了服务器卡顿和网络处理延迟

### 6. 修复了会话过早清理问题
- 增加了会话超时的详细日志
- 改进了会话清理逻辑的调试信息

## 测试步骤

### 1. 重新编译项目
```bash
./gradlew build
```

### 2. 启动服务器
- 观察服务器启动日志，确认认证系统初始化成功
- 检查是否有"共享密钥已配置"的日志

### 3. 启动客户端
- 观察客户端启动日志，确认令牌管理器初始化成功
- 检查是否有"客户端令牌管理器初始化完成"的日志

### 4. 连接测试
- 客户端连接服务器
- 观察日志输出，确认以下流程：
  1. 服务器创建认证会话
  2. 服务器发送挑战给客户端
  3. 客户端接收挑战并生成令牌响应
  4. 服务器接收令牌响应并验证
  5. 认证成功，玩家进入游戏

## 预期日志输出

### 服务器端
```
[INFO] 初始化认证会话管理器...
[INFO] 服务器共享密钥已配置，长度: 32 字节
[INFO] 收到客户端Hello包，开始处理登录认证
[INFO] 为连接 /127.0.0.1:xxxxx 生成连接ID: xxxxx
[INFO] 已创建认证会话，等待玩家进入游戏后发送挑战
[INFO] 收到玩家 xxx 的令牌响应
[INFO] 查找玩家会话 - 玩家: xxx, IP: /127.0.0.1, 活跃会话数: 1
[INFO] 找到匹配的会话 - 玩家: xxx, IP: /127.0.0.1, 会话时间戳: xxxxx
[INFO] 玩家 xxx 认证成功
```

### 客户端
```
[INFO] 客户端令牌管理器初始化完成
[INFO] 收到服务器挑战数据包
[INFO] 开始处理服务器挑战
[INFO] 挑战数据有效，开始生成令牌响应
[INFO] 令牌响应生成成功，长度: 32 字节
[INFO] 已向服务器发送令牌响应
[INFO] 服务器认证成功: xxx
```

## 故障排除

### 如果仍然认证失败
1. 检查服务器日志中的"当前活跃会话"信息
2. 确认客户端和服务器使用相同的共享密钥
3. 检查客户端和服务器的时间差是否在容差范围内
4. 确认网络连接正常，没有防火墙阻止

### 调试命令
在服务器控制台执行：
```
/auth help
```

查看可用的认证管理命令。

## 注意事项
- 确保客户端和服务器配置文件中的共享密钥完全相同
- 如果修改了配置文件，需要重启服务器和客户端
- 日志级别设置为INFO或DEBUG以获取详细信息