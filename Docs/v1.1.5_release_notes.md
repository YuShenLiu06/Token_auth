# Token认证系统 v1.1.5 版本更新日志

## 🎯 版本概述

v1.1.5版本是Token认证系统的一个重要更新，主要增强了安全监控和调试能力，新增了邮件警报系统、IP地理位置追踪、CSV日志记录和详细的调试日志功能。

## 🆕 新增功能

### 1. 邮件警报系统
- **文件**: [`EmailNotifier.java`](src/main/java/nety/ys/util/EmailNotifier.java), [`AuthAlertService.java`](src/main/java/nety/ys/server/AuthAlertService.java)
- **功能**: 当玩家认证失败或超时时，自动发送警报邮件给管理员
- **特性**:
  - 支持SMTP协议，包括SSL加密
  - 可配置发件人、收件人、SMTP服务器等信息
  - 包含详细的认证失败信息：玩家名、IP地址、地理位置、失败原因
  - 异步发送，不影响服务器性能

### 2. IP地理位置追踪
- **文件**: [`IPGeolocationUtil.java`](src/main/java/nety/ys/util/IPGeolocationUtil.java)
- **功能**: 自动获取认证失败玩家的IP地理位置信息
- **特性**:
  - 使用ip-api.com API获取地理位置
  - 包含国家、地区、城市、ISP等信息
  - 支持重试机制和错误处理
  - 可通过配置启用/禁用

### 3. CSV日志记录
- **文件**: [`FailedAuthLogger.java`](src/main/java/nety/ys/util/FailedAuthLogger.java)
- **功能**: 将认证失败记录保存到CSV文件
- **特性**:
  - 自动记录玩家名称、登录时间、IP地址、地理位置
  - 线程安全的文件写入
  - 可配置文件名和记录内容
  - 支持记录认证超时事件

### 4. 调试日志系统
- **文件**: [`DebugLogger.java`](src/main/java/nety/ys/util/DebugLogger.java)
- **功能**: 提供分类的调试日志输出
- **特性**:
  - 支持多种日志类型：DEBUG、VERBOSE、AUTH、CSV、EMAIL
  - 可通过配置启用/禁用调试模式
  - 便于问题诊断和系统监控

### 5. 统一命令系统
- **文件**: [`TokenCommandUnified.java`](src/main/java/nety/ys/server/commands/TokenCommandUnified.java)
- **功能**: 整合所有管理命令到统一的命令接口
- **特性**:
  - 支持配置管理、邮件测试、CSV管理等功能
  - 提供详细的帮助信息
  - 改进的用户交互体验

## 🔧 配置更新

### 新增配置项
```toml
[csv_logging]
# 是否启用CSV记录功能
enableCSVLogging = false
# CSV文件名
csvFileName = "failed_auth_attempts.csv"
# 是否包含地理位置信息
includeGeoLocation = true
# 是否记录认证超时
logTimeoutAttempts = true

[email_alerts]
# 是否启用邮件警报
enableEmailAlerts = false
# SMTP服务器配置
smtpHost = ""
smtpPort = 587
enableSSL = true
smtpUsername = ""
smtpPassword = ""
emailFromAddress = ""
emailToAddress = ""
serverName = "Minecraft服务器"

[logging]
# 是否启用调试模式
debugMode = false
```

## 📋 新增命令

### CSV管理命令
- `/csvstatus` - 查看CSV记录状态
- `/csvenable` - 启用CSV记录
- `/csvdisable` - 禁用CSV记录
- `/csvtest` - 测试CSV记录功能
- `/csvtimeout` - 切换超时记录

### 邮件管理命令
- `/token debug email` - 测试邮件发送功能
<<<<<<< HEAD
- `/token config <配置项> <值>` - 设置邮件配置
=======
- `/token set <配置项> <值>` - 设置邮件配置
>>>>>>> ab356f0f79dea2813a62e982afc364f01852e915

### 调试命令
- `/debugtest` - 测试调试日志功能
- `/debugstatus` - 查看调试模式状态

## 🛠️ 技术改进

### 1. 异步处理
- 邮件发送使用异步方式，避免阻塞主线程
- IP地理位置查询支持重试机制
- CSV文件写入使用文件锁确保线程安全

### 2. 错误处理
- 增强了网络请求的错误处理
- 添加了详细的异常日志记录
- 提供了优雅的降级机制

### 3. 性能优化
- 减少了不必要的网络请求
- 优化了日志输出格式
- 改进了内存使用效率

## 📊 文档更新

### 新增文档
- [`Email_Alert_Configuration_Guide.md`](Email_Alert_Configuration_Guide.md) - 邮件警报配置指南
- [`EMAIL_TROUBLESHOOTING.md`](EMAIL_TROUBLESHOOTING.md) - 邮件功能故障排除
- [`CSV_LOGGING_FEATURE.md`](CSV_LOGGING_FEATURE.md) - CSV日志功能说明
- [`DEBUG_LOGGING_GUIDE.md`](DEBUG_LOGGING_GUIDE.md) - 调试日志指南

### 更新文档
- [`COMMAND_REFERENCE.md`](COMMAND_REFERENCE.md) - 更新了命令参考
- [`README.md`](README.md) - 更新了功能说明和配置指南

## 🔍 故障排除

### 常见问题
1. **邮件发送失败**: 检查SMTP配置和网络连接
2. **地理位置获取失败**: 确认网络连接和API可用性
3. **CSV文件写入失败**: 检查文件权限和磁盘空间
4. **调试日志不显示**: 确认debugMode配置为true

### 调试技巧
- 启用调试模式获取详细日志
- 使用测试命令验证功能
- 检查配置文件语法正确性

## 📈 版本对比

| 功能 | v1.0.0 | v1.1.5 |
|------|--------|--------|
| 邮件警报 | ❌ | ✅ |
| IP地理位置 | ❌ | ✅ |
| CSV日志记录 | ❌ | ✅ |
| 调试日志系统 | ❌ | ✅ |
| 统一命令系统 | ❌ | ✅ |
| 认证核心功能 | ✅ | ✅ |
| 约束系统 | ✅ | ✅ |

## 🎯 总结

v1.1.5版本大幅增强了Token认证系统的监控和调试能力，提供了：

1. **更强的安全监控**: 邮件警报和IP地理位置追踪
2. **更好的数据记录**: CSV日志记录和详细的调试信息
3. **更便捷的管理**: 统一的命令系统和配置管理
4. **更高的可靠性**: 异步处理和错误处理改进

这个版本为服务器管理员提供了全面的认证监控工具，使安全事件能够被及时发现和处理，同时保持了系统的稳定性和性能。

---

**发布日期**: 2025年12月7日  
**兼容版本**: Minecraft 1.19.2  
**所需依赖**: Fabric Loader >=0.14.21, Fabric API >=0.76.0+1.19.2, Java >=17